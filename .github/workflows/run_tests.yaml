name: run-tests

on:
  workflow_run:
    workflows: ["build"] # Name of the previous workflow
    types:
      - completed

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04, ubuntu-latest]

    steps:
      - name: Fetch artifacts from the previous workflow
        id: get-artifact
        run: |
          echo "Fetching available artifacts from the previous workflow..."
          ARTIFACT_NAME="workspace-artifact-${{ matrix.os }}"
          ARTIFACTS=$(curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                            -H "Accept: application/vnd.github.v3+json" \
                            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts)

          # Find the corresponding artifact
          ARTIFACT_ID=$(echo "$ARTIFACTS" | jq -r --arg ARTIFACT_NAME "$ARTIFACT_NAME" \
                          '.artifacts[] | select(.name == $ARTIFACT_NAME) | .id')

          if [ -z "$ARTIFACT_ID" ]; then
            echo "Error: Artifact with name $ARTIFACT_NAME not found."
            exit 1
          fi

          echo "Found artifact with name: $ARTIFACT_NAME and ID: $ARTIFACT_ID"
          echo "::set-output name=artifact_id::$ARTIFACT_ID"

      - name: Download corresponding artifact
        uses: actions/download-artifact@v4
        with:
          artifact-id: ${{ steps.get-artifact.outputs.artifact_id }}
          path: workspace

      - name: Install runtime dependencies
        run: |
          sudo apt update
          sudo apt install -y libboost-all-dev libeigen3-dev libyaml-cpp-dev libpoco-dev liblog4cxx-dev libgtest-dev

      - name: Run GTESTS
        run: |
          cd workspace/install/bin/graph_core/tests
          ./run_all_tests
